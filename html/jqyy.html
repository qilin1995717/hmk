<!DOCTYPE html>
<html>
	<head>
		<title>潮带劲</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

		<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

		<link rel="stylesheet" href="../lib/weui.min.css">
		<link rel="stylesheet" href="../css/jquery-weui.css">
		<link rel="stylesheet" href="css/demos.css">


		<style>
			.cyr{
				list-style: none;
				padding-top: 0;
			}
			.cyr li{
				position: relative;
				padding-bottom: 12px;
			}
			.cyr li p:first-child{
				font-size: 14px
			}
			.cyr li p{
				font-size: 12px;
				color: #1A1A1A;
				margin-top: 12px;
			}
			.cyr li span{
				color: #FF5752;
				font-size: 13px;
				position: absolute;
				top: 40%;
				right: 0;
			}
			.weui-grids:before{
				display: none;
			}
			.icon-only{
				display: none;
			}
			.current-month-value{
				text-align: left;
				width: 100% !important;
			}
			.current-year-value{
				text-align: right;
				width: 100% !important;
			}
			.picker-calendar-week-days{
				background: #FFFFFF;
				color: #B3B3B3;
			}
			.weui-picker-calendar h2{
				color: #1A1A1A;
				font-size: 18px;
				margin-bottom: 30px;
				margin-top: 20px;
			}
			.weui-picker-calendar{
				height: 23rem;
			}
			.picker-calendar-week-days:after{
				display: none;
			}
			.toolbar-inner{
				margin-top: 20px;
				padding: 10px;
				margin-bottom: 5x;
				background: #FFFFFF;
			}
			.picker-calendar-day.picker-calendar-day-selected span{
				border-radius: none;
				background: #1D93EB;
				border-radius: 5px;
			}
			.picker-calendar-day{
				position: relative;
			}
			.picker-calendar-day span p{
				font-size: 10px;
				position: absolute;
				line-height: 1;
				bottom: 3px;
				right: 11px;
			}
			.picker-calendar-row:after{
				display: none;
			}
			.gq{
				background: #B3B3B3;
				color: #333333;
				pointer-events: none;
			}
			.kyy{
				background: #1D93EB;
				color: #FFFFFF !important;
			}
			.ym{
				background: #FF5752;
				color: #FFFFFF !important;
				pointer-events: none;
			}
			.weui-btn:after{
				display: none;
			}
		</style>
	</head>

	<body ontouchstart>
		
		<div class="page">
					<a class="weui-cell weui-cell_access" href="javascript:;">
						<div class="weui-cell__bd">
							<h2 style="font-size: 19px;color: #1A1A1A;"></h2>
							<div class="jqico" style="display: flex;align-items: center;padding-bottom: 10px;justify-content: space-between;">
								
							</div>
						</div>
					</a>
					<a class="weui-cell weui-cell_access" href="javascript:;">
						<div class="">
							<p style="color: #1A1A1A;font-size: 14px;display: flex;align-items: center;">出发日期</p>
						</div>
						<div style="width: 70%;padding-left: 24px;color: #1A1A1A;">
							<input id="date" type="" name="" id="" value="" placeholder="请选择出发日期"/ style="border: none;outline: none;">
						</div>
						<div class="weui-cell__ft">
						</div>
					</a>
				</div>

		<div class="x"></div>
		<a class="weui-cell weui-cell_access" href="javascript:;">
			<div class="">
				<p style="color: #1A1A1A;font-size: 14px;display: flex;align-items: center;">出游人</p>
			</div>
			<div style="width: 70%;padding-left: 24px;color: #1A1A1A;">
				<input type="" name="" id="ren" value="" placeholder="请选择出游人(可多选)"/ style="border: none;outline: none;">
			</div>
			<div class="weui-cell__ft">
			</div>
		</a>
		<a class="weui-cell weui-cell_access" href="javascript:;" style="padding: 0;margin: 0;">
			
		</a>
		<ul class="boxp15 cyr">
			<!-- <li>
				<p>张三</p>
				<p>手机号：18539993343</p>
				<p>身份证：41121119960303002X</p>
			</li>
			<li>
				<p>张三</p>
				<p>手机号：18539993343</p>
				<p>身份证：41121119960303002X</p>
			</li> -->
			
		</ul>
		
		<div class="x"></div>
		<div class="tbsm">
			<h2 class="pagebt">特别说明</h2>
			<ul>
				<li>
					<span class="ic">
						另外费用
					</span>
					<span class="nr">

						5元/人服务费+2元/保险费需会员自理，溶洞景区洞内地势起伏较多；
						
					</span>
				</li>
				<li>
					<span class="ic">
						联系电话
					</span>
					<span class="nr">
						客服电话：0371-69225888；

					</span>
				</li>
				<li>
					<span class="ic">
						注意事项
					</span>
					<span class="nr">

						请注意：此景区不接待团队预约；

					</span>
				</li>
			</ul>
		</div>
		<div class="x"></div>
		<div style="height: 20px;"></div>
		<div style="position: fixed;bottom: 0;display: flex;justify-content: space-between;align-items: center;width: 100%;background:linear-gradient(0deg,rgba(42,103,255,1) 0%,rgba(6,149,255,1) 100%);max-width: 750px;">
			<div class="money" style="width: 50%;text-align: center;font-size: 12px;background: #fff;height: 46px;line-height: 2;">
				总计：<span style="color: #EC1720;"><b style="font-size: 21px;" id="jg">99</b>/1份</span>
			</div>
			<a href="javascript:;" data-target="#half" class="weui-btn weui-btn_primary open-popup" style="border-radius: 0;width: 50%;display: block;background:linear-gradient(0deg,rgba(42,103,255,1) 0%,rgba(6,149,255,1) 100%);" id="next">立即预约</a>
		</div>
		

		



		<script src="../lib/jquery-2.1.4.js"></script>
		<script src="../lib/fastclick.js"></script>
		<script>
			$(function() {
				FastClick.attach(document.body);
			});
		</script>
		<script src="../js/jquery-weui.js"></script>

		<script src="../js/swiper.js"></script>
		<script>
			
			var token = sessionStorage.getItem('token');
			
			//日历
			$("#date").calendar({
			  onChange: function (p, values, displayValues) {
			    console.log(values, displayValues);
			  }
			});
			
			var huoqushijian=new Date();
						
			var nian=huoqushijian.getFullYear();
			var yue=huoqushijian.getMonth();
			var ri=huoqushijian.getDate();
						
			//这样写显示时间在1~9会挤占空间；所以要在1~9的数字前补零;
			if(yue<10){
				yue ='0'+yue;
			}
			if(ri<10){
				ri ='0'+ri;
			}
						
						
			var timeer=nian+''+yue+''+ri;	
						
			// console.log(p.monthHTML		
						
			
			 
			
			//日历
			
			
			
		function GetQueryString(name)
		{
		    var reg = new RegExp("\\b"+ name +"=([^&]*)");
		    var r = location.href.match(reg);
		    if (r!=null) return unescape(r[1]);
		}
		var sn =GetQueryString("valus");
		console.log(sn);
		
			
			
			
			$.ajax({
				url:'http://user.yangergou.com/api/Scenic/scenicCardDate',
				type:'post',
				dataType:'json',
				data:{
					scenic_sn:sn,
				},
				success:function(res){
					console.log(res);
					var kyy = res.data.rows.a;
					var ym =res.data.rows.b;
					var gq = res.data.rows.c;
					
					$("#date").click(function(){
						$(".picker-calendar-day").each(function(){
							var tody = $(this).attr('data-date').split('-').join('');
							// console.log(tody);
							if(tody < timeer){
								$(this).css({"color":"#ccc","user-select":"none"});
							}
							
							if(kyy){
								for(a=0;a< kyy.length;a++){
									var kyyrq = kyy[a].split('-').join('');
									// console.log(kyyrq);
									if(tody == kyyrq){
										$(this).addClass('kyy');
										$(this).find('p').text('可预约');
									}
								}
							}
							
							
							if(ym){
								for(b=0;b<ym.length;b++){
									var ymri = ym[b].split('-').join('');
									// console.log(ymri);
									if(tody == ymri){
										$(this).addClass('ym');
										$(this).find('p').text('已约满');
									}
								}
							}
							
							
							if(gq){
								for(c=0;c<gq.length;c++){
									var gqrq = gq[c].split('-').join('');
									if(tody == gqrq){
										$(this).addClass('gq');
										$(this).find('p').text('已过期');
									}
								}
							}
							
						  });
						
					
						
					})

					
				},
				error:function(e){
					console.log(e);
				}
			})
			
			

			
			
			
			
			
			$('#ren').click(function(){
				sessionStorage.removeItem('xx');
				var timerr = $('#date').val();
				sessionStorage.setItem('timme',timerr);
				var sj = $('#date').val().split("/").join('-');
				console.log(sj);
				if(sj){
					var next = {
						sn:sn,
						sj:sj,
					}
					var next = JSON.stringify(next);
					console.log(next);
					window.location.href = 'jqyy-xzcyr.html?next=' + next;
				}else{
					$.alert('请先选择出发日期');
				}
			})
			
			var xx = JSON.parse(sessionStorage.getItem('xx'));
			var timme = sessionStorage.getItem('timme');
			$('#date').val(timme);
			console.log(xx);
			if(xx){
				var html= '';
				for(i=0;i<xx.tel.length;i++){
					html +="<li>"+
					"<p>"+ xx.uname[i] +"</p>"+
					"<p>手机号："+ xx.tel[i] +"</p>"+
					"<p>身份证："+ xx.identity[i] +"</p>"+
				"</li>"
				}
				$('.cyr').html(html);
				var cardsnn = xx.cardsn;
				var cn ='';
				for(i=0;i<cardsnn.length;i++){
					cn += cardsnn[i] + ','
				}
				
				
				var cn = cn.substr(0,cn.length-1)
			}
			
			console.log(cn);
			
			
			
			var pirce = sessionStorage.getItem('price');
			console.log(pirce);
			if(pirce){
				$('.money').css('display','block');
				$('#jg').text(pirce);
				console.log(pirce);
				$('#next').html('支付预约');
				$('#next').click(function(){
					var timerr = $('#date').val().split('/').join('-')
					$.ajax({
						url:"http://user.yangergou.com/api/Wxpayscenic/index",
						type:"post",
						async:false,
						dataType:"json",
						data:{
							token:token,
							scenic_sn:sn,
							pay_type:1,
							scenic_time:timerr,
							card_sn:cn
							
						},
						success:function(res){
							console.log(res);
							console.log(res.data.list);
							$.ajax({
								url:"http://user.yangergou.com/api/Wxpay/wxpay",
								type:"post",
								dataType:"json",
								data:{
									token:token,
									order_sn:res.data.list,
								},
								success:function(data){
									var data = data.data.list;
									var data = JSON.parse(data);
									console.log(data);
									console.log(data.package);
									function onBridgeReady(){
									   WeixinJSBridge.invoke(
									      'getBrandWCPayRequest', {
									         "appId":data.appId,     //公众号名称，由商户传入     
									         "timeStamp":data.timeStamp,         //时间戳，自1970年以来的秒数     
									         "nonceStr":data.nonceStr, //随机串     
									         "package":data.package,     
									         "signType":"MD5",         //微信签名方式：     
									         "paySign":data.paySign //微信签名 
									      },
									      function(res){
									      if(res.err_msg == "get_brand_wcpay_request:ok" ){
									      // 使用以上方式判断前端返回,微信团队郑重提示：
										  $.modal({
										    title: "潮带劲",
										    text: "预约成功！",
										    buttons: [
										      { text: "返回首页", onClick: function(){ 
										  		window.location.href = 'index.html';
										  	} },
										  					 // className: "default",
										      { text: "查看订单",  onClick: function(){ 
										  		window.location.href = 'jqlist.html';
										  	} },
										    ]
										  });
										  
									            //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
									      }else{
											  $.alert("失败");
										  }
									   }); 
									}
									if (typeof WeixinJSBridge == "undefined"){
									   if( document.addEventListener ){
									       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
									   }else if (document.attachEvent){
									       document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
									       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
									   }
									}else{
									   	onBridgeReady();
									}
									
								}
							})
						},
						
					})
				})
			}else{
				$('.money').css('display','none');
				$('#next').click(function(){
					
					
						var timerr = $('#date').val().split('/').join('-')
						$.ajax({
							url:'http://user.yangergou.com/api/scenic/scenicCardAdd',
							type:'post',
							dataType:'json',
							data:{
								token:token,
								scenic_sn:sn,
								time:timerr,
								card_sn:cn
							},
							success:function(res){
								console.log(res);
								if(res.code == 200 ){
									
									sessionStorage.removeItem('timerr');
									sessionStorage.removeItem('xx');
									
									$('.cyr').html('');
									
									
									$.modal({
									  title: "潮带劲",
									  text: "预约成功！",
									  buttons: [
									    { text: "返回首页", onClick: function(){ 
											window.location.href = 'index.html';
										} },
														 // className: "default",
									    { text: "查看订单",  onClick: function(){ 
											window.location.href = 'jqlist.html';
										} },
									  ]
									});
								}else{
									$.alert(res.msg);
								}
							}
						})
					
					
				})
				
			}
			
			
			
			
		</script>
	</body>
</html>
